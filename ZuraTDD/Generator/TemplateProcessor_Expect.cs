using ZuraTDD.Generator.DataModel;
using System.Linq;

namespace ZuraTDD.Generator;

internal partial class TemplateProcessor
{
	public static string GenerateExpectServiceCode(ServiceSpecification service)
	{
		var methods = service.Methods
			.Select(method => Functions.ServiceBuilderMethodCode(service, method));

		var methodCode = string.Join("\n\n", methods);

		return
			$$"""
			// <auto-generated />
			#nullable enable
			using ZuraTDD;
			
			namespace {{service.OutputNamespace}};

			/// <summary>
			/// An expectation setup object for <see cref="{{service.ServiceTypeName}}" />.
			/// </summary>
			internal class {{service.ExpectTypeName}}
				: {{service.ServiceTypeName}}_ExpectBuilder
			{
				public {{service.ExpectTypeName}}(
					FakeService existingFake)
					: base(new ExpectedServiceCallImmediateProcessor(existingFake))
				{
				}
			}

			internal class {{service.ServiceTypeName}}_ExpectStaticBuilder
				: {{service.ServiceTypeName}}_ExpectBuilder
			{
				public {{service.ServiceTypeName}}_ExpectStaticBuilder(
					string serviceName)
					: base(new ExpectedServiceCallOwnerName(serviceName))
				{
				}
			}
			
			internal class {{service.ServiceTypeName}}_ExpectBuilder
			{
				private IExpectedServiceCallProcessor processor;

				protected {{service.ServiceTypeName}}_ExpectBuilder(
					IExpectedServiceCallProcessor processor)
				{
					this.processor = processor;
				}

			{{methodCode}}
			}
			""";
	}
}

static file class Functions
{
	public static string ServiceBuilderMethodCode(
		ServiceSpecification service,
		MethodSpecification method)
	{
		return
			$$"""
				/// <summary>
				/// Builds call expectations for <see cref="{{service.ServiceTypeName}}.{{method.MethodName}}" />.
				/// </summary>
				public ExpectedServiceCallBuilder {{method.MethodName}}({{PrepareParameterList(method)}})
				{
					return new(
						{{service.ServiceMethodsTypeName}}.{{method.Token}},
						new ValueSetConstraint([
							{{string.Join(",\n\t\t\t\t", method.Parameters.Select(p => $"{p.Name} ?? new ValueConstraint<{p.Type}>()"))}}
						]),
						this.processor);
				}
			""";
	}

	private static string PrepareParameterList(MethodSpecification method)
	{
		if (method.Parameters.Count == 0)
			return "";

		var parameterDeclarations = method.Parameters
			.Select(p => $"ValueConstraint<{p.Type}>? {p.Name} = null");

		return "\n\t\t" + string.Join(",\n\t\t", parameterDeclarations);
	}
}
